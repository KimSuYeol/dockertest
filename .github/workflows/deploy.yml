name: Deploy Frontend to AWS EC2

on:
  push:
    branches:
      - main
    paths:
      - 'seurasaeng_fe/**'
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° ë°°í¬
  deploy-frontend:
    name: Deploy Frontend to Public Server
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: seurasaeng_fe/package-lock.json
        
    - name: Install dependencies
      run: |
        cd seurasaeng_fe
        npm ci
        
    - name: Run tests (optional)
      run: |
        cd seurasaeng_fe
        # npm run test -- --watchAll=false
        echo "Tests skipped for now"
        
    - name: Build React app
      run: |
        cd seurasaeng_fe
        # í™˜ê²½ë³€ìˆ˜ ì„¤ì • í›„ ë¹Œë“œ
        echo "VITE_API_URL=http://13.125.200.221/api" > .env.production
        npm run build
        
    - name: Verify build output
      run: |
        cd seurasaeng_fe
        ls -la dist/
        echo "Build verification completed"
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
        
    - name: Build Docker image (ARM64)
      run: |
        cd seurasaeng_fe
        docker buildx build \
          --platform linux/arm64 \
          --build-arg VITE_API_URL=http://13.125.200.221/api \
          -t seuraseung-frontend:latest . \
          --load
          
    - name: Verify Docker image
      run: |
        docker images | grep seuraseung-frontend
        echo "Docker image verification completed"
        
    - name: Save Docker image
      run: |
        docker save seuraseung-frontend:latest | gzip > seurasaeng_fe-image.tar.gz
        
    - name: Copy files to Front Server
      uses: appleboy/scp-action@v0.1.5
      with:
        host: ${{ secrets.FRONT_SERVER_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "seurasaeng_fe-image.tar.gz,seurasaeng_fe/deploy.sh,seurasaeng_fe/docker-compose.yml,seurasaeng_fe/nginx/"
        target: "/home/ubuntu/"
        timeout: 300s
        
    - name: Deploy Frontend with Health Check
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.FRONT_SERVER_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 600s
        script: |
          set -e
          
          echo "ğŸš€ Starting frontend deployment..."
          
          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ë° ì‹¤í–‰
          chmod +x /home/ubuntu/seurasaeng_fe/deploy.sh
          bash /home/ubuntu/seurasaeng_fe/deploy.sh
          
          echo "âœ… Frontend deployment script completed"

    - name: Frontend Integration Test
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.FRONT_SERVER_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 300s
        script: |
          set -e
          
          echo "ğŸ” Starting frontend integration test..."
          
          # í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸
          MAX_ATTEMPTS=20
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "â³ Testing frontend health... (${ATTEMPT}/${MAX_ATTEMPTS})"
            
            if curl -f -s http://localhost/health > /dev/null; then
              echo "âœ… Frontend health check passed"
              break
            fi
            
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âŒ Frontend health check failed after ${MAX_ATTEMPTS} attempts"
              echo "ğŸ“‹ Container status:"
              cd seurasaeng_fe && docker-compose ps
              echo "ğŸ“‹ Frontend logs:"
              docker logs seuraseung-frontend --tail=50
              exit 1
            fi
            
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          # ë©”ì¸ í˜ì´ì§€ í…ŒìŠ¤íŠ¸
          echo "ğŸ” Testing main page..."
          if curl -f -s http://localhost/ > /dev/null; then
            echo "âœ… Main page is accessible"
          else
            echo "âŒ Main page test failed"
            exit 1
          fi
          
          # ë°±ì—”ë“œ ì—°ê²° í…ŒìŠ¤íŠ¸ (ì‹¤íŒ¨í•´ë„ ë°°í¬ëŠ” ì„±ê³µ)
          echo "ğŸ” Testing backend connectivity..."
          if curl -f -s http://10.0.2.165:8080/api/actuator/health > /dev/null; then
            echo "âœ… Backend connectivity verified"
            
            # API í”„ë¡ì‹œ í…ŒìŠ¤íŠ¸
            if curl -f -s http://localhost/api/actuator/health > /dev/null; then
              echo "âœ… API proxy is working"
            else
              echo "âš ï¸ API proxy test failed (but deployment continues)"
            fi
          else
            echo "âš ï¸ Backend is not available (frontend-only deployment)"
          fi
          
          echo "ğŸ‰ Frontend integration test completed successfully!"

  # ë°°í¬ í›„ ì•Œë¦¼ ë° ì •ë¦¬
  post-deployment:
    name: Post Deployment Tasks
    runs-on: ubuntu-latest
    needs: deploy-frontend
    if: always()
    
    steps:
    - name: Deployment Summary
      run: |
        echo "## Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ needs.deploy-frontend.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.deploy-frontend.result }}" = "success" ]; then
          echo "- **Frontend URL**: http://${{ secrets.FRONT_SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check**: http://${{ secrets.FRONT_SERVER_HOST }}/health" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… SUCCESS" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status**: âŒ FAILED" >> $GITHUB_STEP_SUMMARY
          echo "- **Action Required**: Check deployment logs and consider rollback" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Cleanup on Failure
      if: failure()
      run: |
        echo "ğŸš¨ Deployment failed! Manual intervention may be required."
        echo "ğŸ” Check the following:"
        echo "  1. Server connectivity"
        echo "  2. Docker container status"
        echo "  3. Nginx configuration"
        echo "  4. Frontend build issues"

# ë°±ì—”ë“œ ë°°í¬ (ë³„ë„ ì›Œí¬í”Œë¡œìš°ë¡œ ë¶„ë¦¬í•˜ê±°ë‚˜ í•„ìš”ì‹œ ì£¼ì„ í•´ì œ)
# deploy-backend:
#   name: Deploy Backend to Private Server
#   runs-on: ubuntu-latest
#   if: contains(github.event.head_commit.modified, 'seurasaeng_be/') || github.event_name == 'workflow_dispatch'
#   
#   steps:
#   - name: Checkout code
#     uses: actions/checkout@v4
#     
#   - name: Set up JDK 21
#     uses: actions/setup-java@v4
#     with:
#       java-version: '21'
#       distribution: 'temurin'
#       
#   - name: Cache Maven dependencies
#     uses: actions/cache@v3
#     with:
#       path: ~/.m2
#       key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
#       restore-keys: ${{ runner.os }}-m2
#       
#   - name: Build with Maven
#     run: |
#       cd seurasaeng_be
#       mvn clean package -DskipTests
#       
#   - name: Build Docker image
#     run: |
#       cd seurasaeng_be
#       docker buildx build --platform linux/arm64 -t seuraseung-backend:latest . --load
#       
#   - name: Save Docker image
#     run: |
#       docker save seuraseung-backend:latest | gzip > seurasaeng_be-image.tar.gz
#       
#   - name: Deploy to Backend Server
#     uses: appleboy/ssh-action@v1.0.0
#     with:
#       host: ${{ secrets.BACK_SERVER_HOST }}
#       username: ubuntu
#       key: ${{ secrets.SSH_PRIVATE_KEY }}
#       script: |
#         # ë°±ì—”ë“œ ë°°í¬ ë¡œì§
#         echo "Backend deployment logic here"