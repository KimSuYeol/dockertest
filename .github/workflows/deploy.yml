name: Deploy HTTPS Frontend to AWS EC2

on:
  push:
    branches:
      - main
    paths:
      - 'seurasaeng_fe/**'
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ ë° ë°°í¬
  deploy-frontend:
    name: Deploy HTTPS Frontend to Public Server
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: seurasaeng_fe/package-lock.json
        
    - name: Install dependencies
      run: |
        cd seurasaeng_fe
        npm ci
        
    - name: Run tests (optional)
      run: |
        cd seurasaeng_fe
        # npm run test -- --watchAll=false
        echo "Tests skipped for now"
        
    - name: Build React app for HTTPS
      run: |
        cd seurasaeng_fe
        # HTTPS í™˜ê²½ë³€ìˆ˜ ì„¤ì • í›„ ë¹Œë“œ
        echo "VITE_API_URL=https://seurasaeng.site/api" > .env.production
        npm run build
        
    - name: Verify build output
      run: |
        cd seurasaeng_fe
        ls -la dist/
        echo "Build verification completed"
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
        
    - name: Build Docker image (ARM64) with HTTPS support
      run: |
        cd seurasaeng_fe
        docker buildx build \
          --platform linux/arm64 \
          --build-arg VITE_API_URL=https://seurasaeng.site/api \
          -t seuraseung-frontend:latest . \
          --load
          
    - name: Verify Docker image
      run: |
        docker images | grep seuraseung-frontend
        echo "Docker image verification completed"
        
    - name: Save Docker image
      run: |
        docker save seuraseung-frontend:latest | gzip > seurasaeng_fe-image.tar.gz
        
    - name: Copy files to Front Server
      uses: appleboy/scp-action@v0.1.5
      with:
        host: ${{ secrets.FRONT_SERVER_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "seurasaeng_fe-image.tar.gz,seurasaeng_fe/deploy.sh,seurasaeng_fe/docker-compose.yml,seurasaeng_fe/nginx/"
        target: "/home/ubuntu/"
        timeout: 300s
        
    - name: Deploy HTTPS Frontend with Health Check
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.FRONT_SERVER_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 600s
        script: |
          set -e
          
          echo "ğŸš€ Starting HTTPS frontend deployment..."
          
          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ë° ì‹¤í–‰
          chmod +x /home/ubuntu/seurasaeng_fe/deploy.sh
          bash /home/ubuntu/seurasaeng_fe/deploy.sh
          
          echo "âœ… HTTPS Frontend deployment script completed"

    - name: Frontend Integration Test (HTTP & HTTPS)
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.FRONT_SERVER_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: 300s
        script: |
          set -e
          
          echo "ğŸ” Starting frontend integration test (HTTP & HTTPS)..."
          
          # HTTP í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸
          MAX_ATTEMPTS=20
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "â³ Testing HTTP frontend health... (${ATTEMPT}/${MAX_ATTEMPTS})"
            
            if curl -f -s http://localhost/health > /dev/null; then
              echo "âœ… HTTP Frontend health check passed"
              break
            fi
            
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âŒ HTTP Frontend health check failed after ${MAX_ATTEMPTS} attempts"
              echo "ğŸ“‹ Container status:"
              cd seurasaeng_fe && docker-compose ps
              echo "ğŸ“‹ Frontend logs:"
              docker logs seuraseung-frontend --tail=50
              exit 1
            fi
            
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          # HTTPS í—¬ìŠ¤ì²´í¬ í…ŒìŠ¤íŠ¸
          echo "ğŸ”’ Testing HTTPS frontend health..."
          ATTEMPT=1
          while [ $ATTEMPT -le 10 ]; do
            if curl -f -s -k https://localhost/health > /dev/null; then
              echo "âœ… HTTPS Frontend health check passed"
              break
            fi
            
            if [ $ATTEMPT -eq 10 ]; then
              echo "âš ï¸ HTTPS health check failed, but HTTP is working"
              break
            fi
            
            echo "â³ Waiting for HTTPS... (${ATTEMPT}/10)"
            sleep 15
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          # ë©”ì¸ í˜ì´ì§€ í…ŒìŠ¤íŠ¸ (HTTP)
          echo "ğŸ” Testing HTTP main page..."
          if curl -f -s http://localhost/ > /dev/null; then
            echo "âœ… HTTP Main page is accessible"
          else
            echo "âŒ HTTP Main page test failed"
            exit 1
          fi
          
          # ë©”ì¸ í˜ì´ì§€ í…ŒìŠ¤íŠ¸ (HTTPS)
          echo "ğŸ”’ Testing HTTPS main page..."
          if curl -f -s -k https://localhost/ > /dev/null; then
            echo "âœ… HTTPS Main page is accessible"
          else
            echo "âš ï¸ HTTPS Main page test failed (HTTP still works)"
          fi
          
          # HTTP to HTTPS ë¦¬ë‹¤ì´ë ‰íŠ¸ í…ŒìŠ¤íŠ¸
          echo "ğŸ”„ Testing HTTP to HTTPS redirect..."
          REDIRECT_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/)
          if [ "$REDIRECT_RESPONSE" = "301" ] || [ "$REDIRECT_RESPONSE" = "302" ]; then
            echo "âœ… HTTP to HTTPS redirect is working"
          else
            echo "âš ï¸ HTTP to HTTPS redirect may not be configured properly"
          fi
          
          # ë°±ì—”ë“œ ì—°ê²° í…ŒìŠ¤íŠ¸ (ì‹¤íŒ¨í•´ë„ ë°°í¬ëŠ” ì„±ê³µ)
          echo "ğŸ” Testing backend connectivity..."
          if curl -f -s http://10.0.2.165:8080/api/actuator/health > /dev/null; then
            echo "âœ… Backend connectivity verified"
            
            # HTTPS API í”„ë¡ì‹œ í…ŒìŠ¤íŠ¸
            if curl -f -s -k https://localhost/api/actuator/health > /dev/null; then
              echo "âœ… HTTPS API proxy is working"
            else
              echo "âš ï¸ HTTPS API proxy test failed"
              
              # HTTP API í”„ë¡ì‹œ í…ŒìŠ¤íŠ¸
              if curl -f -s http://localhost/api/actuator/health > /dev/null; then
                echo "âœ… HTTP API proxy is working"
              else
                echo "âš ï¸ HTTP API proxy test also failed"
              fi
            fi
          else
            echo "âš ï¸ Backend is not available (frontend-only deployment)"
          fi
          
          echo "ğŸ‰ Frontend integration test completed!"

  # ë°°í¬ í›„ ì•Œë¦¼ ë° ì •ë¦¬
  post-deployment:
    name: Post Deployment Tasks
    runs-on: ubuntu-latest
    needs: deploy-frontend
    if: always()
    
    steps:
    - name: Deployment Summary
      run: |
        echo "## HTTPS Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ needs.deploy-frontend.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.deploy-frontend.result }}" = "success" ]; then
          echo "- **HTTPS URL**: https://seurasaeng.site" >> $GITHUB_STEP_SUMMARY
          echo "- **HTTP URL**: http://${{ secrets.FRONT_SERVER_HOST }} (redirects to HTTPS)" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check (HTTPS)**: https://seurasaeng.site/health" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check (HTTP)**: http://${{ secrets.FRONT_SERVER_HOST }}/health" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… SUCCESS (HTTPS ENABLED)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status**: âŒ FAILED" >> $GITHUB_STEP_SUMMARY
          echo "- **Action Required**: Check deployment logs and SSL certificate status" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Cleanup on Failure
      if: failure()
      run: |
        echo "ğŸš¨ HTTPS Deployment failed! Manual intervention may be required."
        echo "ğŸ” Check the following:"
        echo "  1. Server connectivity"
        echo "  2. Docker container status"
        echo "  3. Nginx configuration"
        echo "  4. SSL certificate issues"
        echo "  5. Domain DNS settings"
        echo "  6. Frontend build issues"

# SSL ì¸ì¦ì„œ ê°±ì‹  ì‘ì—… (ë³„ë„ ìŠ¤ì¼€ì¤„)
  ssl-renewal:
    name: SSL Certificate Renewal Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Renew SSL Certificates
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.FRONT_SERVER_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ğŸ”„ Checking SSL certificate renewal..."
          if [ -f "/home/ubuntu/renew-ssl.sh" ]; then
            bash /home/ubuntu/renew-ssl.sh
            echo "âœ… SSL renewal check completed"
          else
            echo "âš ï¸ SSL renewal script not found"
          fi